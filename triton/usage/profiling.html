

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Profiling &mdash; Aalto scientific computing</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
    <link rel="top" title="Aalto scientific computing" href="../../index.html"/>
        <link rel="up" title="Triton user guide" href="../index.html"/>
        <link rel="next" title="Quotas" href="quotas.html"/>
        <link rel="prev" title="MPI on Triton" href="mpilibs.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Aalto scientific computing
          

          
            
            <img src="../../_static/aalto.png" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../aalto/welcomeresearchers.html">Welcome, researchers!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aalto/welcomestudents.html">Welcome, students!</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../news/index.html">News</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aalto/index.html">The Aalto environment</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data/index.html">Data</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Triton user guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#quick-contents-and-links">Quick contents and links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#tutorials">Tutorials</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#detailed-instructions">Detailed instructions</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="compilers.html">Available compilers</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="dgx.html">Nvidia DGX machines</a></li>
<li class="toctree-l3"><a class="reference internal" href="faq.html">Frequently asked questions</a></li>
<li class="toctree-l3"><a class="reference internal" href="general.html">Running programs on Triton</a></li>
<li class="toctree-l3"><a class="reference internal" href="gpu.html">GPU Computing</a></li>
<li class="toctree-l3"><a class="reference internal" href="grid.html">Grid computing</a></li>
<li class="toctree-l3"><a class="reference internal" href="grid2.html">Grid computing 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="jobs.html">Monitoring jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="libs.html">Libraries</a></li>
<li class="toctree-l3"><a class="reference internal" href="localstorage.html">Storage: local drives</a></li>
<li class="toctree-l3"><a class="reference internal" href="lustre.html">Storage: Lustre (scratch)</a></li>
<li class="toctree-l3"><a class="reference internal" href="mpilibs.html">MPI on Triton</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Profiling</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#summary-profiling-on-linux">Summary: profiling on Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cpu-profiling">CPU profiling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-output-profiling">Input/output profiling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#memory-profiling">Memory profiling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mpi-and-parallel-profiling">MPI and parallel profiling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="quotas.html">Quotas</a></li>
<li class="toctree-l3"><a class="reference internal" href="singularity.html">Singularity Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="smallfiles.html">Small files</a></li>
<li class="toctree-l3"><a class="reference internal" href="storage.html">Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="toolchains.html">Compilers and toolchains</a></li>
<li class="toctree-l3"><a class="reference internal" href="workflows.html">Remote workflows at Aalto</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#applications">Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#reference-and-examples">Reference and Examples</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scicomp/index.html">Scientific computing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../training/index.html">Training</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">About these docs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Aalto scientific computing</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Triton user guide</a> &raquo;</li>
      
    <li>Profiling</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/AaltoScienceIT/scicomp-docs/blob/master/triton/usage/profiling.rst" class="fa fa-github"> Edit on GitHub</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="profiling">
<h1>Profiling<a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Also see <a class="reference internal" href="debugging.html"><em>Debugging</em></a>.</p>
</div>
<p>You have code, you want it to run fast. This is what Triton is for. But
how do you know if your code is running as fast as it can? We are
scientists, and if things aren&#8217;t quantified we can&#8217;t do science on them.
Programming can often seem like a black box: modern computers are
extremely complicated, and people can&#8217;t predict what is actually making
code fast or slow anymore. Thus, you need to <em>profile</em> your code: get
detailed performance measurements. These measurements let you know how
to make it run faster.</p>
<p>There are many tools for profiling, and it really is one of the
fundamental principles for any programming language. You really should
learn how to do quick profile just to make sure things are OK, even if
you aren&#8217;t trying to optimize things: you might find a quick win even if
you didn&#8217;t write the code yourself (for example, 90% of your time is
spent on input/output).</p>
<p>This page is under development, but so far serves as an introduction. We
hope to expand it with specific Triton examples.</p>
<div class="section" id="summary-profiling-on-linux">
<h2>Summary: profiling on Linux<a class="headerlink" href="#summary-profiling-on-linux" title="Permalink to this headline">¶</a></h2>
<p>First off, look at your language-specific profiling tools.</p>
<ul class="simple">
<li>Generic Linux profiling tools (big and comprehensive list, also some
presentations):<a class="reference external" href="http://www.brendangregg.com/linuxperf.html">http://www.brendangregg.com/linuxperf.html</a></li>
<li>Profiling in C and Python (introduction + examples):
<a class="reference external" href="http://rkd.zgib.net/scicomp/profiling/profiling.html">http://rkd.zgib.net/scicomp/profiling/profiling.html</a></li>
</ul>
</div>
<div class="section" id="cpu-profiling">
<h2>CPU profiling<a class="headerlink" href="#cpu-profiling" title="Permalink to this headline">¶</a></h2>
<p>This can give you a list of where all your processor time is going,
either per-function or per-line. Generally, most of your time is in a
very small region of your code, and you need to know what this is in
order to improve <em>just</em> that part.</p>
<p>See the C and Python profiling example above.</p>
<div class="section" id="gnu-gprof">
<h3>GNU gprof<a class="headerlink" href="#gnu-gprof" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://sourceware.org/binutils/docs/gprof/">gprof</a> is a profiler
based on instrumenting your code (build with -pg). It has relatively
high overhead, but gives exact information e.g. for the number of times
a function is called.</p>
</div>
<div class="section" id="perf">
<h3>Perf<a class="headerlink" href="#perf" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://perf.wiki.kernel.org/index.php/Tutorial">perf</a> is a
<em>sampling profiler</em>, which periodically samples <em>events</em> originating
e.g. from the CPU performance monitoring unit (PMU). This generates a
statistical profile, but the advantage is that the overhead is very low
(single digit %), and one can get timings at the level of individual asm
instructions. For a simple example, consider a (naive) matrix
multiplication program:</p>
<p>Compile the program (-g provides debug symbols which will be useful
later on, at no performance cost):</p>
<div class="highlight-python"><div class="highlight"><pre>$ gfortran -Wall -g -O3 mymatmul.f90
</pre></div>
</div>
<p>Run the program via the profiler to generate profile data:</p>
<div class="highlight-python"><div class="highlight"><pre>$ perf record ./a.out
</pre></div>
</div>
<p>Now we can look at the profile:</p>
<div class="highlight-python"><div class="highlight"><pre>$ perf report
# Samples: 1251
#
# Overhead Command Shared Object Symbol
# ........ .............. ............................. ......
#
85.45% a.out ./a.out [.] MAIN\_\_
4.24% a.out /usr/lib/libgfortran.so.3.0.0 [.] \_gfortran\_arandom\_r4
3.12% a.out /usr/lib/libgfortran.so.3.0.0 [.] kiss\_random\_kernel
</pre></div>
</div>
<p>So 85% of the runtime is spent in the main program (symbol MAIN__),
and most of the rest is in the random number generator, which the
program calls in order to generate the input matrices.</p>
<p>Now, lets take a closer look at the main program:</p>
<div class="highlight-python"><div class="highlight"><pre>$ perf annotate MAIN__
------------------------------------------------
Percent \| Source code &amp; Disassembly of a.out
------------------------------------------------
:
:
:
: Disassembly of section .text:
:
: 00000000004008b0 &lt;MAIN__&gt;:
</pre></div>
</div>
<p>...</p>
<div class="highlight-python"><div class="highlight"><pre>: c = 0.
:
: do j = 1, n
: do k = 1, n
: do i = 1, n
: c(i,j) = c(i,j) + a(i,k) \* b(k,j)
30.12 : 400a40: 0f 28 04 01 movaps (%rcx,%rax,1),%xmm0
4.92 : 400a44: 0f 59 c1 mulps %xmm1,%xmm0
12.36 : 400a47: 0f 58 04 02 addps (%rdx,%rax,1),%xmm0
40.73 : 400a4b: 0f 29 04 02 movaps %xmm0,(%rdx,%rax,1)
9.65 : 400a4f: 48 83 c0 10 add $0x10,%rax
</pre></div>
</div>
<p>Unsurprisingly, the inner loop kernel takes up practically all the time.</p>
<p>For more information on using perf, see the perf tutorial at</p>
<p><a class="reference external" href="https://perf.wiki.kernel.org/index.php/Tutorial">https://perf.wiki.kernel.org/index.php/Tutorial</a></p>
</div>
</div>
<div class="section" id="input-output-profiling">
<h2>Input/output profiling<a class="headerlink" href="#input-output-profiling" title="Permalink to this headline">¶</a></h2>
<p>This will tell you how much time is spent reading and writing data,
where, and what type of patterns it has (big reads, random access, etc).
Note that you can see the time information when CPU profiling: if
input/output functions take a lot of time, you need to improve IO.</p>
<p><code class="docutils literal"><span class="pre">/usr/bin/time</span> <span class="pre">-v</span></code> prints some useful info about IO operations and
statistics.</p>
<p>Lowest level: use strace to print the time taken in every system call
that accesses files. This is not that great.:</p>
<div class="highlight-python"><div class="highlight"><pre>#  Use strace to print the total bytes
strace -e trace=desc $command |&amp; egrep &#39;write&#39; | awk --field-separator=&#39;=&#39;  &#39;{ x+=$NF } END { print x }&#39;
strace -e trace=desc $command |&amp; egrep &#39;read&#39; | awk --field-separator=&#39;=&#39;  &#39;{ x+=$NF } END { print x }&#39;

# Number of calls only
strace -e trace=file -c  $command
</pre></div>
</div>
</div>
<div class="section" id="memory-profiling">
<h2>Memory profiling<a class="headerlink" href="#memory-profiling" title="Permalink to this headline">¶</a></h2>
<p>Less common, but it can tell you something about what memory is being
used.</p>
<p>If you are making your own algorithms, memory profiling becomes more
important because you need to be sure that you are using the memory
hierarchy efficiently. There are tools for this.</p>
</div>
<div class="section" id="mpi-and-parallel-profiling">
<h2>MPI and parallel profiling<a class="headerlink" href="#mpi-and-parallel-profiling" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mpip">
<h3>mpiP<a class="headerlink" href="#mpip" title="Permalink to this headline">¶</a></h3>
<p>mpiP: Lightweight, Scalable MPI Profiling <a class="reference external" href="http://mpip.sourceforge.net/">http://mpip.sourceforge.net/</a>.
Collects statistical information about MPI functions. mpiP is a
link-time library, that means that it can be linked to the object file,
though it is recommended that you have recompiled the code with -g.
Debugging information is used to decode the program counters to a source
code filename and line number automatically. mpiP will work without -g,
but mileage may vary.</p>
<p>Usage example:</p>
<div class="highlight-python"><div class="highlight"><pre># assume you have you MPI flavor module loaded
module load mpip/3.4.1

# link or compile your code from scratch with -g
mpif90 ­-g ­-o my_app my_app.f90 ­-lmpiP ­-lm ­-lbfd ­-liberty ­-lunwind
# or
mpif90 ­-o my_app my_app.o ­-lmpiP ­-lm ­-lbfd ­-liberty ­-lunwind

# run the code normally (either interactively with salloc or as usual with sbatch)
salloc ­-p play ­-n 4 srun mpi_app
</pre></div>
</div>
<p>If everything works, you will see the mpiP header preceding your program
stdout, and there will be generated a text report file in your work
directory. File is small, no worries about quota. Please, consult the
link above for the file content explanation. During runtime, one can set
MPIP environment variables to change the profiler behavior. Example:</p>
<div class="highlight-python"><div class="highlight"><pre>export MPIP=&quot;-t 10.0 -k 2&quot;
</pre></div>
</div>
</div>
<div class="section" id="scalasca">
<h3>Scalasca<a class="headerlink" href="#scalasca" title="Permalink to this headline">¶</a></h3>
<p>Available through module load scalasca</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="quotas.html" class="btn btn-neutral float-right" title="Quotas" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mpilibs.html" class="btn btn-neutral" title="MPI on Triton" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Aalto Science-IT.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/redirect-to-https.js"></script>
      <script type="text/javascript" src="https://users.aalto.fi/~darstr1/minipres-stable.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>