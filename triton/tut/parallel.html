

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Parallel computing &mdash; Aalto scientific computing</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
    <link rel="top" title="Aalto scientific computing" href="../../index.html"/>
        <link rel="up" title="Triton user guide" href="../index.html"/>
        <link rel="next" title="Job dependencies" href="dependency.html"/>
        <link rel="prev" title="GPU computing" href="gpu.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Aalto scientific computing
          

          
            
            <img src="../../_static/aalto.png" class="logo" />
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../aalto/welcomeresearchers.html">Welcome, researchers!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aalto/welcomestudents.html">Welcome, students!</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../news/index.html">News</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aalto/index.html">The Aalto environment</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data/index.html">Data</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Triton user guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#quick-contents-and-links">Quick contents and links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#overview">Overview</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#tutorials">Tutorials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro.html">About Science-IT and Triton</a></li>
<li class="toctree-l3"><a class="reference internal" href="connecting.html">Connecting to Triton</a></li>
<li class="toctree-l3"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="modules.html">Software Modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="storage.html">Data storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="interactive.html">Interactive jobs: running your first command</a></li>
<li class="toctree-l3"><a class="reference internal" href="serial.html">Serial jobs: running in the queue</a></li>
<li class="toctree-l3"><a class="reference internal" href="array.html">Array jobs</a></li>
<li class="toctree-l3"><a class="reference internal" href="gpu.html">GPU computing</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Parallel computing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#parallel-programming-models">Parallel programming models</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shared-memory-openmp-programs">Shared memory: OpenMP programs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#other-programs-and-multithreading">Other programs and multithreading</a></li>
<li class="toctree-l4"><a class="reference internal" href="#message-passing-programs-mpi">Message passing programs: MPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitoring-performance">Monitoring performance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exercises">Exercises</a></li>
<li class="toctree-l4"><a class="reference internal" href="#next-steps">Next steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dependency.html">Job dependencies</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#detailed-instructions">Detailed instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#applications">Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#reference-and-examples">Reference and Examples</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../scicomp/index.html">Scientific computing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../training/index.html">Training</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">About these docs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Aalto scientific computing</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Triton user guide</a> &raquo;</li>
      
    <li>Parallel computing</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/AaltoScienceIT/scicomp-docs/blob/master/triton/tut/parallel.rst" class="fa fa-github"> Edit on GitHub</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="parallel-computing">
<h1>Parallel computing<a class="headerlink" href="#parallel-computing" title="Permalink to this headline">¶</a></h1>
<p>Parallel computing is what HPC is really all about: processing things on
more than one CPU at once. By now, you should have read all of the previous
tutorials.</p>
<div class="section" id="parallel-programming-models">
<h2>Parallel programming models<a class="headerlink" href="#parallel-programming-models" title="Permalink to this headline">¶</a></h2>
<p>Parallel programming is a completely different way of programming.  Most
Triton users don&#8217;t need to write their own
applications, at most they will be running existing programs, but in
order to understand things, we start with some introduction.</p>
<p>The two main models are:</p>
<ul class="simple">
<li>Shared memory program (or multithreading) runs on only one node
because, like the name says, all the memory has to be accessible to
all the processes.  Thus, scaleability is limited to a number of CPU
cores available within one computational node. The code is
easier to implement and the same code can still be run in a serial mode.
Examples of application that utilize this model: Matlab, R, OpenMP
applications, typical parallel desktop programs.</li>
<li>Message passing programming (e.g. MPI, message passing interface)
can run on multiple nodes interconnected with the network via passing
data through MPI software libraries. The large-scale scientific programs
are MPI. MPI can scale to thousands of CPU cores, but it&#8217;s harder to
implement from the programmer point of view.</li>
</ul>
<p>Both models, MPI and shared memory, can be combined in one application, in
this case we are talking about hybrid parallel programming model.</p>
<p>Most historical scientific code is MPI, but these days more and more
people are using shared memory models.</p>
<p>The important note is that a normal, serial code can&#8217;t just be run as
parallel without modifications. As a user it is your responsibility to
understand what parallel model implementation your code has, if any.
Knowing this, you can proceed with the instructions below.</p>
<p>Another important note regarding parallelism is that all the applications
scale good up to some upper limit which depends on application implementation,
size and type of problem you solve and some other factors. The best practice
is to benchmark your code on different number of CPU cores before actual
production run.</p>
<p><strong>If you want to run some program in parallel, you have to know
something about it - is it shared memory or MPI?  A program doesn&#8217;t
magically get faster when you ask more processors if it&#8217;s not designed
to.</strong></p>
</div>
<div class="section" id="shared-memory-openmp-programs">
<h2>Shared memory: OpenMP programs<a class="headerlink" href="#shared-memory-openmp-programs" title="Permalink to this headline">¶</a></h2>
<p>OpenMP is a standard de facto for the multithreading implementations. There
are many others, but this one is the most common, supported by all known
compiler suits. For other implementations of shared memory parallelism,
please consult your code docs.</p>
<p>Simple code compiling:</p>
<div class="highlight-python"><div class="highlight"><pre>gcc -fopenmp -O2 -g omp_program.c -o omp_program
</pre></div>
</div>
<p>Running an OpenMP code:</p>
<div class="highlight-python"><div class="highlight"><pre>export OMP_PROC_BIND=TRUE
srun --cpus-per-task=12 --mem-per-cpu=2000 --time=45:00 omp_program
</pre></div>
</div>
<p>The basic slurm options you need are <code class="docutils literal"><span class="pre">--cpus-per-task=N</span></code> (or <code class="docutils literal"><span class="pre">-c</span> <span class="pre">N</span></code>) to specify the number of
cores to use within one node.  If your memory needs scale with the number of cores,
use <code class="docutils literal"><span class="pre">--mem-per-core=</span></code>, if you require a fixed amount of memory (per
node regardless of number of processors), use <code class="docutils literal"><span class="pre">--mem</span></code>.</p>
<p>The SLURM batch file will look similar:</p>
<div class="highlight-python"><div class="highlight"><pre>#!/bin/bash -l
#SBATCH --cpus-per-task=12
#SBATCH  --mem-per-cpu=2000
#SBATCH --time=45:00
export OMP_PROC_BIND=TRUE
srun omp_program
</pre></div>
</div>
<p>Good to know that OpenMP is both an environment and set of libraries, but
those libraries always come as part of the compiler, thus no need to
load extra modules if you compile with the default <code class="docutils literal"><span class="pre">gcc</span></code>.</p>
</div>
<div class="section" id="other-programs-and-multithreading">
<h2>Other programs and multithreading<a class="headerlink" href="#other-programs-and-multithreading" title="Permalink to this headline">¶</a></h2>
<p>Some programs use multiple threads for their parallel computations. A good
example of this kind of program is MATLAB, that user parallel pool of workers;
or R, which uses the <code class="docutils literal"><span class="pre">parallel</span></code>-package for its parallel applys.
Threaded applications behave similarly to OpenMP applications in that one
needs to specify the number of cores per task and amount of memory per core.</p>
</div>
<div class="section" id="message-passing-programs-mpi">
<h2>Message passing programs: MPI<a class="headerlink" href="#message-passing-programs-mpi" title="Permalink to this headline">¶</a></h2>
<p>For compiling/running an MPI job one has to pick up one of the MPI library suites.
Big vendors provide their own (Cray, Intel) while there are other popular MPI
flavors available. To compile and run code you need to pick one. Since most of
the MPI codes will also use math libs, makes sense to pick a toolchain that
provides all at once.</p>
<p>For basic use of MPI programs, you usually need the <code class="docutils literal"><span class="pre">-n</span></code> option to
specify the number of MPI threads.</p>
<p>Loading module:</p>
<div class="highlight-python"><div class="highlight"><pre>module load openmpi  # GCC + OpenMPI
</pre></div>
</div>
<p>Compiling a code:</p>
<div class="highlight-python"><div class="highlight"><pre>mpif90 -O2 -g mpi_prog.f -o mpi_prog
</pre></div>
</div>
<p>Running an MPI code in the batch mode:</p>
<div class="highlight-python"><div class="highlight"><pre>#!/bin/bash
#SBATCH -n 16                # 16 processes
#SBATCH --constraint=avx     # run on nodes with AVX instructions
#SBATCH --time=4:00:00       # takes 4 hours all together
#SBATCH --mem-per-cpu=4000   # 4GB per process

module load openmpi  # NOTE: should same as you used to compile the code
srun ./mpi_prog
</pre></div>
</div>
<p>Triton has multiple architectures around (12, 20, 24, 40 CPU cores per node),
even though SLURM optimizes resources usage and allocate CPUs within one node, which
gives better performance for the app, it still makes sense to put constraints
explicitly.</p>
</div>
<div class="section" id="monitoring-performance">
<h2>Monitoring performance<a class="headerlink" href="#monitoring-performance" title="Permalink to this headline">¶</a></h2>
<p>You can use the <code class="docutils literal"><span class="pre">seff</span></code> program (with a jobid) to list what percent
of available processors and memory you used.  If your processor usage
is far below, your code may not be working correctly in a parallel
environment.</p>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Run <code class="docutils literal"><span class="pre">srun</span> <span class="pre">-c</span> <span class="pre">4</span> <span class="pre">hostname</span></code>, <code class="docutils literal"><span class="pre">srun</span> <span class="pre">-n</span> <span class="pre">4</span> <span class="pre">hostname</span></code>, and <code class="docutils literal"><span class="pre">srun</span> <span class="pre">-N</span> <span class="pre">4</span>
<span class="pre">hostname</span></code>.  What&#8217;s the difference and why?</li>
</ol>
<p>In <code class="docutils literal"><span class="pre">triton-examples</span></code> (at <code class="docutils literal"><span class="pre">/scratch/scip/examples</span></code>), you find some
examples.</p>
<ol class="arabic simple" start="2">
<li>Find the files <code class="docutils literal"><span class="pre">openmp/hello_omp.c</span></code> and <code class="docutils literal"><span class="pre">openmp/hello_omp.slrm</span></code>
that have a short
example of OpenMP.  Compile and run it - a slurm script is included.</li>
<li>Find the files <code class="docutils literal"><span class="pre">mpi/hello_mpi.c</span></code> and <code class="docutils literal"><span class="pre">mpi/hello_mpi.slrm</span></code> that
have a short example
of MPI.  Compile and run it - a slurm script is included.</li>
</ol>
</div>
<div class="section" id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>See the next pages:</p>
<ul class="simple">
<li>You can check the <a class="reference internal" href="../usage/general.html"><em>Running programs on Triton</em></a> page for the reference
information on running jobs.  This contains the general reference
information.</li>
<li><a class="reference internal" href="../usage/mpilibs.html"><em>MPI on Triton</em></a></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dependency.html" class="btn btn-neutral float-right" title="Job dependencies" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="gpu.html" class="btn btn-neutral" title="GPU computing" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Aalto Science-IT.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/redirect-to-https.js"></script>
      <script type="text/javascript" src="https://users.aalto.fi/~darstr1/minipres-stable.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>